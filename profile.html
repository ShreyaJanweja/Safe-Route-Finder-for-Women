<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile — Suraksha Sathi</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body id="pageBody" class="bg-slate-100 min-h-screen text-slate-800">
  <!-- HEADER with Back + Logo -->
  <header class="bg-gradient-to-r from-indigo-600 to-indigo-400 text-white p-4 shadow-md">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="btnBack" aria-label="Back" class="inline-flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded text-sm">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="hidden sm:inline">Back</span>
        </button>

        <a href="index.html" class="flex items-center gap-3">
          <div class="w-10 h-10 flex-shrink-0">
            <img src="logo.png" alt="Suraksha Sathi" class="w-full h-full object-cover rounded-full" />
          </div>
          <div class="hidden sm:block">
            <div class="text-lg font-semibold leading-tight text-white">Suraksha Sathi</div>
            <div class="text-xs opacity-90 -mt-0.5 text-white">Because Every Journey Deserves Safety</div>
          </div>
        </a>
      </div>

      <div id="navAuth" class="ml-3"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto mt-8 px-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Profile Card -->
      <section class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center gap-4">
          <div id="avatar" class="w-20 h-20 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 text-2xl font-bold"></div>
          <div>
            <div id="displayName" class="text-xl font-semibold">User</div>
            <div id="displayEmail" class="text-sm text-slate-500">email@example.com</div>
            <div id="displayJoin" class="text-xs text-slate-400 mt-1">Joined: —</div>
          </div>
        </div>

        <div class="mt-4 space-x-2">
          <button id="btnEditProfile" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded shadow-sm">Edit Profile</button>
          <button id="btnChangePassword" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded">Change Password</button>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-semibold text-slate-600">Emergency Contacts</h3>
          <ul id="emergencyList" class="mt-2 space-y-2 text-sm text-slate-700"></ul>

          <form id="emergencyForm" class="mt-3 grid grid-cols-1 gap-2">
            <input id="emergencyName" type="text" placeholder="Name" class="px-3 py-2 border rounded" />
            <input id="emergencyPhone" type="tel" placeholder="Phone (10 digits)" class="px-3 py-2 border rounded" inputmode="numeric" />
            <div class="flex gap-2">
              <button type="submit" class="px-3 py-2 bg-indigo-600 text-white rounded">Add</button>
              <button id="clearContacts" type="button" class="px-3 py-2 bg-white border rounded">Clear All</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Stats + Activity (span 2 cols) -->
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-lg font-semibold">Safety Insights</h2>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Safe Routes Taken</div>
              <div id="statRoutes" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Reports Sent</div>
              <div id="statReports" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Alerts Received</div>
              <div id="statAlerts" class="text-2xl font-semibold mt-1">0</div>
            </div>
          </div>

          <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-600">Recent Activity</h3>
            <ul id="activityList" class="mt-3 space-y-3 text-sm text-slate-700"></ul>
          </div>
        </div>

        <!-- Settings -->
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Settings & Preferences</h2>
            <div class="text-xs text-slate-500">Manage your account</div>
          </div>

          <div class="mt-4 space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Enable Notifications</div>
                <div class="text-xs text-slate-500">Receive app alerts</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleNotifications" type="checkbox" class="sr-only" />
                <span id="notifSpan" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors"></span>
              </label>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Privacy: Share profile</div>
                <div class="text-xs text-slate-500">Who can see your profile</div>
              </div>
              <select id="privacySelect" class="border rounded px-2 py-1 text-sm">
                <option value="private">Private</option>
                <option value="contacts">Contacts only</option>
                <option value="public">Public</option>
              </select>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Dark Mode</div>
                <div class="text-xs text-slate-500">Switch theme</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleDark" type="checkbox" class="sr-only" />
                <span id="darkSwitch" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors"></span>
              </label>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="mt-8">
    <div class="max-w-6xl mx-auto text-center text-xs text-slate-500 py-4">© <span id="year">2025</span> Suraksha Sathi — Your Safety , Our Priority</div>
  </footer>

  <!-- Edit & Pwd Modals (kept same) -->
  <div id="modalEdit" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-lg font-semibold mb-3">Edit Profile</h3>
      <form id="editForm" class="space-y-3">
        <input id="editUsername" type="text" class="w-full px-3 py-2 border rounded" placeholder="Username" />
        <input id="editEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="Email" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEdit" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modalPwd" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-lg font-semibold mb-3">Change Password</h3>
      <form id="pwdForm" class="space-y-3">
        <input id="currentPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Current password" />
        <input id="newPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="New password" />
        <input id="confirmNewPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Confirm new password" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelPwd" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Update</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      // Back button behavior (same logic used across pages)
      document.addEventListener('DOMContentLoaded', function () {
        const backBtn = document.getElementById('btnBack');
        if (backBtn) {
          backBtn.addEventListener('click', function (e) {
            e.preventDefault();
            try {
              if (window.history && window.history.length > 1) { window.history.back(); return; }
              if (document.referrer) {
                try {
                  const r = new URL(document.referrer);
                  if (r.origin === location.origin) { window.location.href = document.referrer; return; }
                } catch (err) {}
              }
              window.location.href = 'index.html';
            } catch (err) { window.location.href = 'index.html'; }
          });
        }
      });

      // safe helpers
      const esc = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const el = id => document.getElementById(id);
      function getUsers(){ try{ return JSON.parse(localStorage.getItem('users')||'[]'); }catch(e){ return []; } }

      // auth check
      const authUser = JSON.parse(localStorage.getItem('authUser') || 'null');
      if(!authUser){ window.location.href = 'login.html'; return; }

      // render header auth
      const nav = el('navAuth');
      if(nav){
        nav.innerHTML = `
          <a href="profile.html" class="inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded text-sm">${esc(authUser.username||authUser.email)}</a>
          <button id="logoutBtn" class="ml-2 px-3 py-1 rounded bg-white/10 border border-white/20 text-sm">Logout</button>
        `;
        const logoutBtn = el('logoutBtn');
        logoutBtn && logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('authUser'); window.location.href = 'login.html'; });
      }

      // find full user record
      const users = getUsers();
      const me = users.find(u => u.email === authUser.email) || { username: authUser.username, email: authUser.email, created: Date.now() };

      // populate profile header safely
      const avatar = el('avatar'), nameEl = el('displayName'), emailEl = el('displayEmail'), joinEl = el('displayJoin');
      const initials = ((me.username || me.email || 'U').trim().split(/\s+/)[0] || 'U').charAt(0).toUpperCase();
      if(avatar) avatar.textContent = initials;
      if(nameEl) nameEl.textContent = me.username || authUser.username || '';
      if(emailEl) emailEl.textContent = me.email || authUser.email || '';
      if(joinEl){
        const joined = me.created ? new Date(me.created) : new Date();
        joinEl.textContent = 'Joined: ' + joined.toLocaleDateString();
      }

      // stats
      const statRoutes = Number(localStorage.getItem('stat_routes')||0);
      const statReports = Number(localStorage.getItem('stat_reports')||0);
      const statAlerts = Number(localStorage.getItem('stat_alerts')||0);
      el('statRoutes') && (el('statRoutes').textContent = statRoutes);
      el('statReports') && (el('statReports').textContent = statReports);
      el('statAlerts') && (el('statAlerts').textContent = statAlerts);

      // activity
      function loadActivity(){
        let acts = [];
        try{ acts = JSON.parse(localStorage.getItem('activity')||'[]'); }catch(e){ acts = []; }
        if(!acts.length){
          acts = [
            { when: Date.now()-3600*1000, text: 'Checked a safe route' },
            { when: Date.now()-3600*24*1000, text: 'Reported an area' },
            { when: Date.now()-3600*48*1000, text: 'Viewed community post' }
          ];
        }
        const list = el('activityList');
        if(!list) return;
        list.innerHTML = acts.slice(0,6).map(a => `<li class="p-3 rounded bg-slate-50 flex justify-between items-start">
          <div>${esc(a.text)}</div><div class="text-xs text-slate-400">${new Date(a.when).toLocaleString()}</div></li>`).join('');
      }
      loadActivity();

      // emergency contacts
      function loadContacts(){
        let c = [];
        try{ c = JSON.parse(localStorage.getItem('emergencyContacts')||'[]'); }catch(e){ c = []; }
        const ul = el('emergencyList');
        if(!ul) return;
        if(!c.length) ul.innerHTML = '<li class="text-xs text-slate-400">No emergency contacts yet.</li>';
        else ul.innerHTML = c.map((ct, i)=>`<li class="flex items-center justify-between bg-slate-50 p-2 rounded">
          <div><div class="font-medium">${esc(ct.name)}</div><div class="text-xs text-slate-500">${esc(ct.phone)}</div></div>
          <button data-i="${i}" class="removeContact text-red-500 text-sm">Remove</button>
        </li>`).join('');
        ul.querySelectorAll('.removeContact').forEach(btn=>{
          btn.addEventListener('click', ()=> {
            const idx = Number(btn.dataset.i);
            c.splice(idx,1);
            localStorage.setItem('emergencyContacts', JSON.stringify(c));
            loadContacts();
          });
        });
      }
      loadContacts();

      // add contact
      const emergencyForm = el('emergencyForm');
      emergencyForm && emergencyForm.addEventListener('submit', function(e){
        e.preventDefault();
        const name = (el('emergencyName') && el('emergencyName').value.trim()) || '';
        const phone = (el('emergencyPhone') && el('emergencyPhone').value.trim()) || '';
        if(!name || !/^\d{10}$/.test(phone)){ alert('Enter name and 10-digit phone.'); return; }
        const arr = JSON.parse(localStorage.getItem('emergencyContacts')||'[]');
        arr.unshift({ name, phone });
        localStorage.setItem('emergencyContacts', JSON.stringify(arr));
        el('emergencyName') && (el('emergencyName').value = '');
        el('emergencyPhone') && (el('emergencyPhone').value = '');
        loadContacts();
      });

      const clearBtn = el('clearContacts');
      clearBtn && clearBtn.addEventListener('click', ()=>{ if(confirm('Clear all emergency contacts?')){ localStorage.removeItem('emergencyContacts'); loadContacts(); } });

      // settings load/save
      const defaultSettings = { notifications: true, privacy: 'contacts', dark: false };
      const settings = Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem('settings')||'{}'));
      const notif = el('toggleNotifications'), privacy = el('privacySelect'), dark = el('toggleDark');

      function applySettings(){
        if(notif) notif.checked = !!settings.notifications;
        if(privacy) privacy.value = settings.privacy || 'contacts';
        if(dark) dark.checked = !!settings.dark;
        if(settings.dark){
          document.getElementById('pageBody').classList.add('dark','bg-slate-900','text-slate-100');
        } else {
          document.getElementById('pageBody').classList.remove('dark','bg-slate-900','text-slate-100');
        }
        el('notifSpan') && (el('notifSpan').style.backgroundColor = settings.notifications ? '#4f46e5' : '#cbd5e1');
        el('darkSwitch') && (el('darkSwitch').style.backgroundColor = settings.dark ? '#111827' : '#cbd5e1');
      }
      applySettings();

      notif && notif.addEventListener('change', ()=>{ settings.notifications = notif.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });
      privacy && privacy.addEventListener('change', ()=>{ settings.privacy = privacy.value; localStorage.setItem('settings', JSON.stringify(settings)); });
      dark && dark.addEventListener('change', ()=>{ settings.dark = dark.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });

      // Edit profile modal handlers
      const modalEdit = el('modalEdit'), editForm = el('editForm');
      el('btnEditProfile') && el('btnEditProfile').addEventListener('click', ()=>{ el('editUsername') && (el('editUsername').value = me.username || ''); el('editEmail') && (el('editEmail').value = me.email || ''); modalEdit && modalEdit.classList.remove('hidden'); });
      el('cancelEdit') && el('cancelEdit').addEventListener('click', ()=> modalEdit && modalEdit.classList.add('hidden'));

      editForm && editForm.addEventListener('submit', function(e){
        e.preventDefault();
        const nu = (el('editUsername') && el('editUsername').value.trim()) || '';
        const ne = (el('editEmail') && el('editEmail').value.trim().toLowerCase()) || '';
        if(!nu || !ne){ alert('Provide username and email.'); return; }

        const all = getUsers();
        const idx = all.findIndex(u=>u.email === me.email);
        if(idx >= 0){
          const other = all.find((u,i)=>u.email === ne && i !== idx);
          if(other){ alert('Email already used by another account.'); return; }
          all[idx].username = nu; all[idx].email = ne;
          localStorage.setItem('users', JSON.stringify(all));
        } else {
          all.push({ username: nu, email: ne, created: me.created || Date.now() });
          localStorage.setItem('users', JSON.stringify(all));
        }
        const newAuth = { username: nu, email: ne };
        localStorage.setItem('authUser', JSON.stringify(newAuth));
        el('displayName') && (el('displayName').textContent = nu);
        el('displayEmail') && (el('displayEmail').textContent = ne);
        modalEdit && modalEdit.classList.add('hidden');
        alert('Profile updated.');
        setTimeout(()=> location.reload(), 300);
      });

      // Change password handlers
      const modalPwd = el('modalPwd'), pwdForm = el('pwdForm');
      el('btnChangePassword') && el('btnChangePassword').addEventListener('click', ()=> modalPwd && modalPwd.classList.remove('hidden'));
      el('cancelPwd') && el('cancelPwd').addEventListener('click', ()=> modalPwd && modalPwd.classList.add('hidden'));

      pwdForm && pwdForm.addEventListener('submit', function(e){
        e.preventDefault();
        const cur = (el('currentPwd') && el('currentPwd').value) || '';
        const nw = (el('newPwd') && el('newPwd').value) || '';
        const cn = (el('confirmNewPwd') && el('confirmNewPwd').value) || '';
        if(!cur || !nw || !cn){ alert('Fill all fields.'); return; }
        if(nw !== cn){ alert('New passwords do not match.'); return; }
        const all = getUsers();
        const idx = all.findIndex(u => u.email === me.email);
        if(idx === -1 || all[idx].password !== cur){
          alert('Current password incorrect.');
          return;
        }
        all[idx].password = nw;
        localStorage.setItem('users', JSON.stringify(all));
        modalPwd && modalPwd.classList.add('hidden');
        alert('Password updated.');
      });

      // footer year
      el('year') && (el('year').textContent = new Date().getFullYear());
    })();
  </script>
</body>
</html>