<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile ‚Äî Suraksha Sathi</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }
    .modal-inner {
      max-height: 78vh;
      overflow: auto;
      padding: 1.25rem;
      box-sizing: border-box;
    }
    .modal-inner input,
    .modal-inner select,
    .modal-inner button { box-sizing: border-box; min-width: 0; }

    .modal-inner .ec-card, .modal-inner .ec-card * { word-break: break-word; }
    .ec-save-btn { white-space: nowrap; }

    .modal-inner ::-webkit-input-placeholder { color: #94a3b8; }
    .modal-inner ::-moz-placeholder { color: #94a3b8; }
    .modal-inner :-ms-input-placeholder { color: #94a3b8; }
    .modal-inner ::placeholder { color: #94a3b8; }

    .ec-save-wrapper, .ec-save-btn { display: inline-flex; align-items: center; justify-content: center; }

    .modal-inner input:focus,
    .modal-inner select:focus,
    .modal-inner button:focus {
      outline: 3px solid rgba(99,102,241,0.12);
      outline-offset: 2px;
    }

    @media (max-width: 640px) {
      .modal-inner { padding: 0.75rem; max-height: 85vh; }
      .ec-row { flex-direction: column; gap: 0.5rem; }
      .ec-save-wrapper { justify-content: flex-end; }
    }

    .ec-card { background: #fff0f6; border: 1px solid #ffd6e7; color: #372b2f; }
    .ec-remove { cursor:pointer; color:#e11d48; font-weight:600; background:transparent; border:0; }

    .fixed.inset-0.bg-black\/40 { z-index: 999; }

    /* SOS alert modal + toast */
    .sos-alert-modal{position:fixed;left:50%;top:18%;transform:translateX(-50%) scale(.9);background:linear-gradient(90deg,#ef4444,#be123c);color:#fff;padding:1.25rem 1.5rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:1100;opacity:0;pointer-events:none;transition:all .25s ease}
    .sos-alert-modal.show{opacity:1;transform:translateX(-50%) scale(1)}
    .sos-alert-modal .title{font-weight:700;margin-bottom:.25rem}
    .sos-toast{position:fixed;right:18px;bottom:18px;background:#065f46;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,.3);z-index:1200;opacity:0;transform:translateY(6px);transition:all .22s ease}
    .sos-toast.show{opacity:1;transform:translateY(0)}
    .sos-heard { margin-top:8px; font-size:0.95rem; color:#0f172a; }
    .sos-heard .line { padding:6px 8px; background:#f8fafc; border-radius:6px; margin-top:6px; border:1px solid #e6eef7; }

  /* full-screen flashing red overlay for emergency */
  .sos-overlay{position:fixed;inset:0;z-index:1150;background:rgba(239,68,68,0.0);pointer-events:none;opacity:0;transition:opacity .12s linear}
  .sos-overlay.show{opacity:1;pointer-events:auto;animation:sosFlash 0.6s ease-in-out infinite}
  @keyframes sosFlash{0%{background:rgba(239,68,68,0.18)}50%{background:rgba(239,68,68,0.45)}100%{background:rgba(239,68,68,0.18)}}

  .sos-stop-btn{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:8px;background:#111827;color:#fff;font-weight:600;cursor:pointer}

    /* small visual glow when triggered */
    .alert-glow { box-shadow: 0 0 0 6px rgba(239,68,68,0.06) inset, 0 6px 30px rgba(0,0,0,0.06); }
  </style>
</head>

<body id="pageBody" class="bg-slate-100 min-h-screen text-slate-800">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-indigo-600 to-indigo-400 text-white p-4 shadow-md">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="btnBack" aria-label="Back" class="inline-flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded text-sm" onclick="window.location.href='index.html'">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>
          <span class="hidden sm:inline">Back</span>
        </button>

        <a href="index.html" class="flex items-center gap-3">
          <div class="w-10 h-10 flex-shrink-0">
            <img src="logo.png" alt="Suraksha Sathi" class="w-full h-full object-cover rounded-full" />
          </div>
          <div class="hidden sm:block">
            <div class="text-lg font-semibold leading-tight text-white">Suraksha Sathi</div>
            <div class="text-xs opacity-90 -mt-0.5 text-white">Because Every Journey Deserves Safety</div>
          </div>
        </a>
      </div>

      <div id="navAuth" class="ml-3"></div>
    </div>
  </header>

  <script>
  (function(){
    const userJson = localStorage.getItem('currentUser') || localStorage.getItem('authUser');
    const token = localStorage.getItem('authToken') || localStorage.getItem('authUser');
    
    // If not logged in, redirect
    if (!userJson && !token) {
      window.location.href = 'login.html';
      return;
    }

    let user = {};
    try {
      user = userJson ? JSON.parse(userJson) : {};
    } catch(e) {
      user = {};
    }

    // Show user info in header
    const userName = user.username || user.email || 'User';
    const nav = document.getElementById('navAuth');
    if(nav) {
      nav.innerHTML = `
        <span class="text-white text-sm">${userName}</span>
        <button id="logoutBtn" class="ml-2 px-3 py-1 rounded bg-white/10 text-sm hover:bg-white/20">Logout</button>
      `;
      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        localStorage.removeItem('authUser');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      });
    }
  })();
  </script>

  <main class="max-w-6xl mx-auto mt-8 px-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Profile Card -->
      <section class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center gap-4">
          <div id="avatar" class="w-20 h-20 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 text-2xl font-bold"></div>
          <div>
            <div id="displayName" class="text-xl font-semibold">User</div>
            <div id="displayEmail" class="text-sm text-slate-500">email@example.com</div>
            <div id="displayJoin" class="text-xs text-slate-400 mt-1">Joined: ‚Äî</div>
          </div>
        </div>

        <div class="mt-4 space-x-2">
          <button id="btnEditProfile" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded shadow-sm">Edit Profile</button>
          <button id="btnChangePassword" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded">Change Password</button>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-semibold text-slate-600">Emergency Contacts</h3>

          <div class="mt-3">
            <p class="text-xs text-slate-400 mb-3">Manage trusted contacts who will be notified in an emergency. Contacts are saved to your account.</p>
            <button id="openECModal" class="inline-flex items-center gap-3 px-4 py-2 rounded-md bg-pink-600 hover:bg-pink-700 text-white shadow">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8.5v7a2.5 2.5 0 002.5 2.5h13A2.5 2.5 0 0021 15.5v-7A2.5 2.5 0 0018.5 6h-13A2.5 2.5 0 003 8.5zM8 12h8M8 15h5" /></svg>
              Manage Emergency Contacts
            </button>
          </div>

          <!-- Inline small list (account-specific) -->
          <ul id="emergencyList" class="mt-4 space-y-2 text-sm text-slate-700"></ul>

          <!-- Voice SOS controls (per-account) -->
          <div class="mt-4 p-4 bg-white rounded border">
            <h4 class="font-semibold mb-2">Voice SOS</h4>
            <p class="text-xs text-slate-500 mb-2">Set a custom voice command and start the listener. When your spoken phrase matches, your emergency contacts will receive an SMS composer with your location (you must send the SMS from your device).</p>

            <!-- command input -->
            <input id="sosCmd" type="text" placeholder="e.g., help me 123" class="w-full px-3 py-2 border rounded mb-2 text-slate-700 placeholder-slate-400" />

            <!-- control row: Save + Start -->
            <div class="flex items-center gap-2">
              <button id="saveSosBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">Save Command</button>

              <!-- NOTE: To match your snippet exactly, id is startListening -->
              <button id="startListening" class="px-3 py-2 rounded bg-rose-600 text-white">Start Voice Listener</button>

              <!-- status element your snippet uses (id=status) -->
              <div id="status" class="text-xs text-slate-500 ml-auto">Status: idle</div>
            </div>

            <!-- live heard lines area -->
            <div class="sos-heard" id="sosHeardArea"></div>
          </div>

          <!-- SOS alert modal & toast (hidden by default) -->
          <div id="sosAlertModal" class="sos-alert-modal" aria-hidden="true">
            <div class="title">Emergency triggered</div>
            <div class="desc">We've prepared messages for your emergency contacts. Please confirm sending on your device.</div>
          </div>
          <div id="sosToast" class="sos-toast" aria-hidden="true">SOS messages opened in your SMS app</div>
          <!-- full-screen overlay & stop alarm control -->
          <div id="sosOverlay" class="sos-overlay" aria-hidden="true"></div>
          <div id="sosControls" style="position:fixed;left:50%;top:10px;transform:translateX(-50%);z-index:1250;pointer-events:none;">
            <button id="stopAlarmBtn" class="sos-stop-btn" style="pointer-events:auto;display:none;">Stop Alarm</button>
          </div>
        </div>
      </section>

      <!-- Stats + Activity (span 2 cols) -->
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-lg font-semibold">Safety Insights</h2>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Safe Routes Taken</div>
              <div id="statRoutes" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Reports Sent</div>
              <div id="statReports" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Alerts Received</div>
              <div id="statAlerts" class="text-2xl font-semibold mt-1">0</div>
            </div>
          </div>

          <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-600">Recent Activity</h3>
            <ul id="activityList" class="mt-3 space-y-3 text-sm text-slate-700"></ul>
          </div>
        </div>

        <!-- Settings -->
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Settings & Preferences</h2>
            <div class="text-xs text-slate-500">Manage your account</div>
          </div>

          <div class="mt-4 space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Enable Notifications</div>
                <div class="text-xs text-slate-500">Receive app alerts</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleNotifications" type="checkbox" class="sr-only" />
                <span id="notifSpan" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors" aria-hidden="true"></span>
              </label>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Privacy: Share profile</div>
                <div class="text-xs text-slate-500">Who can see your profile</div>
              </div>
              <select id="privacySelect" class="border rounded px-2 py-1 text-sm">
                <option value="private">Private</option>
                <option value="contacts">Contacts only</option>
                <option value="public">Public</option>
              </select>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Dark Mode</div>
                <div class="text-xs text-slate-500">Switch theme</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleDark" type="checkbox" class="sr-only" />
                <span id="darkSwitch" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors" aria-hidden="true"></span>
              </label>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="mt-8">
    <div class="max-w-6xl mx-auto text-center text-xs text-slate-500 py-4">¬© <span id="year">2025</span> Suraksha Sathi ‚Äî Your Safety , Our Priority</div>
  </footer>

  <!-- Edit Modal -->
  <div id="modalEdit" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md modal-inner">
      <h3 class="text-lg font-semibold mb-3">Edit Profile</h3>
      <form id="editForm" class="space-y-3">
        <input id="editUsername" type="text" class="w-full px-3 py-2 border rounded" placeholder="Username" />
        <input id="editEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="Email" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEdit" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="modalPwd" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md modal-inner">
      <h3 class="text-lg font-semibold mb-3">Change Password</h3>
      <form id="pwdForm" class="space-y-3">
        <input id="currentPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Current password" />
        <input id="newPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="New password" />
        <input id="confirmNewPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Confirm new password" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelPwd" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Emergency Contacts Modal -->
  <div id="ecModal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl modal-inner">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold">Emergency Contacts</h3>
        <button id="closeECModal" class="text-slate-500 hover:text-slate-700" aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <p class="text-xs text-slate-400 mt-2">Add the people you'd like to notify in an emergency. These contacts are saved per account.</p>

      <form id="ecForm" class="mt-4">
        <div class="grid grid-cols-12 gap-2 items-center ec-row">
          <div class="col-span-12 md:col-span-5">
            <input id="ecName" type="text" placeholder="Name" class="w-full px-3 py-2 border rounded text-slate-700 placeholder-slate-400" />
          </div>

          <div class="col-span-6 md:col-span-2">
            <select id="countrySelect" class="w-full px-3 py-2 border rounded text-sm text-slate-700">
              <option value="+91">üáÆüá≥ IN +91 (India)</option>
              <option value="+1">üá∫üá∏ US +1 (USA)</option>
              <option value="+44">üá¨üáß GB +44 (UK)</option>
              <option value="+61">üá¶üá∫ AU +61 (Australia)</option>
              <option value="+81">üáØüáµ JP +81 (Japan)</option>
              <option value="+49">üá©üá™ DE +49 (Germany)</option>
              <option value="+33">üá´üá∑ FR +33 (France)</option>
              <option value="+971">üá¶üá™ AE +971 (UAE)</option>
              <option value="+7">üá∑üá∫ RU +7 (Russia)</option>
              <option value="+86">üá®üá≥ CN +86 (China)</option>
            </select>
          </div>

          <div class="col-span-6 md:col-span-3">
            <input id="ecPhone" type="tel" placeholder="Phone Number" class="w-full px-3 py-2 border rounded text-slate-700 placeholder-slate-400" />
          </div>

          <div class="col-span-12 md:col-span-2 flex items-center gap-2">
            <select id="relationSelect" class="flex-1 px-3 py-2 border rounded text-sm text-slate-700">
              <option value="">Relation</option>
              <option value="Friend">Friend</option>
              <option value="Mother">Mother</option>
              <option value="Sister">Sister</option>
              <option value="Brother">Brother</option>
              <option value="Father">Father</option>
              <option value="Boyfriend">Boyfriend</option>
              <option value="Uncle">Uncle</option>
              <option value="Aunt">Aunt</option>
              <option value="Other">Other</option>
            </select>

            <button id="saveContactBtn" type="submit" class="px-3 py-2 rounded-md bg-pink-600 hover:bg-pink-700 text-white ec-save-btn w-24 text-center">Save</button>
          </div>
        </div>
      </form>

      <div class="mt-4">
        <div class="flex items-center justify-between">
          <h4 class="font-semibold">Saved Contacts</h4>
          <div class="flex items-center gap-2">
            <button id="clearAllEC" class="px-3 py-1 rounded border text-sm">Clear All</button>
          </div>
        </div>

        <ul id="ecList" class="mt-3 space-y-3"></ul>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // helpers
      const esc = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const el = id => document.getElementById(id);
      const API_URL = 'http://localhost:3001/api';

      // API call helper
      async function apiCall(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('authToken');
        const opts = {
          method,
          headers: {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
          }
        };
        if(body) opts.body = JSON.stringify(body);
        try {
          const res = await fetch(`${API_URL}${endpoint}`, opts);
          if(!res.ok) {
            if(res.status === 401) {
              localStorage.removeItem('authToken');
              window.location.href = 'login.html';
              return null;
            }
            return null;
          }
          return await res.json();
        } catch(e) {
          console.error('API error:', e);
          return null;
        }
      }

      // user record - fetch from API
      let userProfile = null;
      async function loadUserProfile() {
        try {
          const data = await apiCall('/user/profile');
          if(data && data.user) {
            userProfile = data.user;
            updateProfileUI();
            loadStatistics();
          } else {
            // Fallback: use currentUser from localStorage
            console.warn('API call failed, using localStorage data');
            userProfile = currentUser;
            updateProfileUI();
            loadStatistics();
          }
        } catch(err) {
          console.error('Error loading profile:', err);
          // Fallback: use currentUser from localStorage
          userProfile = currentUser;
          updateProfileUI();
          loadStatistics();
        }
      }

      function updateProfileUI() {
        if(!userProfile) return;
        const avatar = el('avatar'), nameEl = el('displayName'), emailEl = el('displayEmail'), joinEl = el('displayJoin');
        const initials = ((userProfile.username || userProfile.email || 'U').trim().split(/\s+/)[0] || 'U').charAt(0).toUpperCase();
        if(avatar) avatar.textContent = initials;
        if(nameEl) nameEl.textContent = userProfile.username || userProfile.email || '';
        if(emailEl) emailEl.textContent = userProfile.email || '';
        if(joinEl){
          const joined = userProfile.createdAt ? new Date(userProfile.createdAt) : new Date();
          joinEl.textContent = 'Joined: ' + joined.toLocaleDateString();
        }
      }

      function loadStatistics() {
        if(!userProfile) return;
        el('statReports') && (el('statReports').textContent = userProfile.reportsCount || 0);
        el('statAlerts') && (el('statAlerts').textContent = userProfile.sosCount || 0);
        el('statRoutes') && (el('statRoutes').textContent = userProfile.safeRoutesCount || 0);
      }

      // activity
      function loadActivity(){
        // For now, show dummy activity - can be enhanced with /api/user/sos-history
        let acts = [
          { when: Date.now()-3600*1000, text: 'Checked a safe route' },
          { when: Date.now()-3600*24*1000, text: 'Reported an area' },
          { when: Date.now()-3600*48*1000, text: 'Viewed community post' }
        ];
        const list = el('activityList');
        if(!list) return;
        list.innerHTML = acts.slice(0,6).map(a => `<li class="p-3 rounded bg-slate-50 flex justify-between items-start"><div>${esc(a.text)}</div><div class="text-xs text-slate-400">${new Date(a.when).toLocaleString()}</div></li>`).join('');
      }
      
      loadUserProfile();
      loadActivity();

      // ----- Emergency Contacts modal + API persistence -----
      const ecModal = el('ecModal'), openECModal = el('openECModal'), closeECModal = el('closeECModal');
      const ecForm = el('ecForm'), ecName = el('ecName'), ecPhone = el('ecPhone'), countrySelect = el('countrySelect'), relationSelect = el('relationSelect');
      const saveContactBtn = el('saveContactBtn'), ecList = el('ecList'), clearAllEC = el('clearAllEC');

      function readEC() { return (userProfile && userProfile.emergencyContacts) || []; }
      
      async function writeEC(arr) {
        // Save to backend
        const result = await apiCall('/user/profile', 'PUT', { emergencyContacts: arr });
        if(result && result.user) {
          userProfile = result.user;
          renderECs();
          renderInlineECList();
        }
      }

      function renderECs(){
        const arr = readEC();
        if(!ecList) return;
        if(!arr.length){ ecList.innerHTML = '<li class="text-xs text-slate-400">No emergency contacts yet.</li>'; return; }
        ecList.innerHTML = arr.map((c, idx) => `
          <li class="p-3 rounded ec-card flex justify-between items-start">
            <div>
              <div class="font-semibold">${esc(c.name)}</div>
              <div class="text-sm text-slate-600">Phone: ${esc(c.country)} ${esc(c.phone)}</div>
              <div class="text-sm text-slate-600">Relation: ${esc(c.relation)}</div>
            </div>
            <div class="ml-4 text-sm">
              <button class="ec-remove" data-idx="${idx}" title="Remove contact">‚úñ</button>
            </div>
          </li>
        `).join('');
        const removes = ecList.querySelectorAll('.ec-remove');
        removes.forEach(btn => btn.addEventListener('click', function(){
          const i = Number(this.getAttribute('data-idx'));
          const list = readEC();
          if(i>=0 && i<list.length){ list.splice(i,1); writeEC(list); }
        }));
      }

      openECModal && openECModal.addEventListener('click', ()=>{ ecModal && ecModal.classList.remove('hidden'); renderECs(); renderInlineECList(); });
      closeECModal && closeECModal.addEventListener('click', ()=>{ ecModal && ecModal.classList.add('hidden'); });

      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ ecModal && ecModal.classList.add('hidden'); modalEdit && modalEdit.classList.add('hidden'); modalPwd && modalPwd.classList.add('hidden'); }});

      ecForm && ecForm.addEventListener('submit', function(e){
        e.preventDefault();
        const name = (ecName.value || '').trim();
        const phoneRaw = (ecPhone.value || '').replace(/\D/g,'').trim();
        const country = countrySelect.value || '';
        const relation = relationSelect.value || '';

        if(!name){ alert('Please enter a name'); ecName.focus(); return; }
        if(!phoneRaw){ alert('Please enter a phone number'); ecPhone.focus(); return; }
        if(!relation){ alert('Please select relation'); relationSelect.focus(); return; }

        const list = readEC();
        const exists = list.some(it => it.phone === phoneRaw && it.country === country);
        if(exists){ alert('This contact already exists.'); return; }

        list.push({ id: Date.now(), name, phone: phoneRaw, country, relation });
        writeEC(list);
        ecForm.reset();
      });

      clearAllEC && clearAllEC.addEventListener('click', function(){
        if(!confirm('Clear all emergency contacts for this account?')) return;
        writeEC([]);
      });

      function renderInlineECList(){
        const ul = el('emergencyList');
        if(!ul) return;
        const arr = readEC();
        if(!arr.length){ ul.innerHTML = '<li class="text-xs text-slate-400">No emergency contacts yet. Click "Manage Emergency Contacts" to add.</li>'; return; }
        ul.innerHTML = arr.map((ct, i)=>`<li class="flex items-center justify-between bg-slate-50 p-2 rounded"><div><div class="font-medium">${esc(ct.name)}</div><div class="text-xs text-slate-500">${esc(ct.country)} ${esc(ct.phone)}</div></div><button data-i="${i}" class="removeContact text-red-500 text-sm">Remove</button></li>`).join('');
        ul.querySelectorAll('.removeContact').forEach(btn=>{ btn.addEventListener('click', ()=>{ const idx = Number(btn.dataset.i); const arr2 = readEC(); arr2.splice(idx,1); writeEC(arr2); }); });
      }

      // initial render
      renderECs(); 
      renderInlineECList();

      // ----- Voice SOS integration with backend API -----
      const sosCmdInput = el('sosCmd'), saveSosBtn = el('saveSosBtn'), startSosBtn = el('startListening'), sosHeard = el('sosHeardArea');
      const status = el('status'); // status element used by your snippet

      function loadSosCmd(){ 
        try{ 
          if(userProfile && userProfile.voiceCommand) {
            sosCmdInput && (sosCmdInput.value = userProfile.voiceCommand);
          }
        }catch(e){} 
      }

      async function saveSosCmd(){ 
        try{ 
          if(!sosCmdInput) return; 
          const cmd = sosCmdInput.value.trim();
          const result = await apiCall('/user/profile', 'PUT', { voiceCommand: cmd });
          if(result && result.user) {
            userProfile = result.user;
            if(status) {
              status.textContent = 'Status: command saved'; 
              setTimeout(()=>status && (status.textContent='Status: idle'),1500);
            }
          }
        }catch(e){} 
      }

      saveSosBtn && saveSosBtn.addEventListener('click', saveSosCmd);
      loadSosCmd();

      // Provide getContacts() as your snippet expects (returns array of contacts from backend)
      function getContacts(){
        try{ return readEC(); }catch(e){ return []; }
      }

      // ------- Speech recognition ------- (keeps the same names your snippet used)
      let recognition = null;
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-IN';
        recognition.interimResults = false;
        recognition.continuous = true;
        recognition.onresult = (e) => {
          const text = e.results[e.results.length-1][0].transcript.trim();

          // update visual heard area and status (so both are visible)
          try {
            if(sosHeard){
              const div = document.createElement('div'); div.className = 'line'; div.textContent = text;
              sosHeard.insertBefore(div, sosHeard.firstChild);
              while(sosHeard.children.length > 6) sosHeard.removeChild(sosHeard.lastChild);
            }
          } catch(err){ /* ignore */ }

          if(status) status.textContent = 'Heard: ' + text;
          checkCommand(text);
        };
        recognition.onerror = (e)=>{ console.error(e); if(status) status.textContent = 'Error: '+ (e.error || e.message || 'unknown'); };
        recognition.onend = ()=>{ if(status) status.textContent = 'Listener stopped'; };
      } else {
        if(status) status.textContent = 'SpeechRecognition not supported in this browser';
      }

      // checkCommand should read saved command; if matched, trigger SOS flow
      function checkCommand(spoken) {
        const cmd = (userProfile && userProfile.voiceCommand || '').toLowerCase();
        if(!cmd) { console.log('no cmd set'); return; }
        if (spoken.toLowerCase().includes(cmd)) {
          if(status) status.textContent = 'Trigger matched! Preparing messages...';
          // short alarm sound
          playSOSSound();
          // visual glow
          document.body.classList.add('alert-glow');
          setTimeout(()=>document.body.classList.remove('alert-glow'),5000);

          // show modal + toast
          const m = el('sosAlertModal'), t = el('sosToast');
          if(m){ m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
          if(t){ t.classList.add('show'); t.setAttribute('aria-hidden','false'); }
          setTimeout(()=>{ if(m){ m.classList.remove('show'); m.setAttribute('aria-hidden','true'); } }, 5000);
          setTimeout(()=>{ if(t){ t.classList.remove('show'); t.setAttribute('aria-hidden','true'); } }, 4200);

          // start persistent buzzer + flashing overlay
          try{ startBuzzer(); }catch(e){ console.warn('buzzer failed', e); }

          triggerSOS();
        }
      }

      // --- Play emergency sound ---
      function playSOSSound(){
        try{ const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'); audio.play().catch(()=>{}); }catch(e){}
      }

      // --- persistent buzzer + overlay (snooze-able) ---
      let _buzzerAudio = null;
      let _buzzerPlaying = false;
      function startBuzzer(){
        if(_buzzerPlaying) return;
        try{
          _buzzerAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
          _buzzerAudio.loop = true;
          _buzzerAudio.volume = 0.8;
          _buzzerAudio.play().catch(()=>{});
          _buzzerPlaying = true;
        }catch(e){ console.warn('buzzer audio error', e); }
        // show overlay and stop button
        const overlay = el('sosOverlay');
        const stopBtn = el('stopAlarmBtn');
        if(overlay){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
        if(stopBtn){ stopBtn.style.display = 'inline-block'; stopBtn.style.pointerEvents = 'auto'; }
      }

      function stopBuzzer(){
        try{ if(_buzzerAudio){ _buzzerAudio.pause(); _buzzerAudio.currentTime = 0; } }catch(e){}
        _buzzerPlaying = false;
        const overlay = el('sosOverlay');
        const stopBtn = el('stopAlarmBtn');
        if(overlay){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
        if(stopBtn){ stopBtn.style.display = 'none'; stopBtn.style.pointerEvents = 'none'; }
      }

      // stop alarm button
      const stopAlarmBtn = el('stopAlarmBtn');
      if(stopAlarmBtn){ stopAlarmBtn.addEventListener('click', function(){ stopBuzzer(); if(status) status.textContent = 'Alarm stopped'; }); }

      /* Fallback send: open sms: links (with live location link)
         Message will be prefilled. User must tap send (browser security).
      */
      function triggerSOS() {
        const contacts = getContacts();
        if(!contacts || !contacts.length){ alert('No contacts saved'); return; }

        // helper: open sms: composer fallback for each contact
        function openSmsFallback(contacts, messageEncoded){
          contacts.forEach((c)=>{
            const phone = (c.phone || '').replace(/\s+/g,'').replace(/[^0-9+]/g,'');
            if(!phone) return;
            const smsUrl = 'sms:' + phone + '?body=' + messageEncoded;
            try{ window.open(smsUrl,'_blank'); }catch(e){}
          });
        }

        // helper: send SOS via backend API
        async function sendSosViaAPI(contacts, messagePlain, locationObj){
          try{
            const endpoint = `${API_URL}/sos`;
            const controller = new AbortController();
            const to = setTimeout(()=>controller.abort(), 8000);
            const token = localStorage.getItem('authToken');
            const resp = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
              },
              body: JSON.stringify({ contacts: contacts, message: messagePlain, location: locationObj }),
              signal: controller.signal
            });
            clearTimeout(to);
            if(!resp.ok) {
              const txt = await resp.text().catch(()=>null);
              return { ok:false, status: resp.status, text: txt };
            }
            const data = await resp.json().catch(()=>null);
            return { ok:true, data };
          }catch(err){
            return { ok:false, error: err && err.message ? err.message : String(err) };
          }
        }

        // Helper to get geolocation as a promise (short timeout)
        function getLocationPromise(timeoutMs){
          return new Promise((resolve)=>{
            if(!navigator.geolocation) return resolve(null);
            let done = false;
            const timer = setTimeout(()=>{ if(!done){ done=true; resolve(null); } }, timeoutMs||5000);
            navigator.geolocation.getCurrentPosition((pos)=>{
              if(done) return; done = true; clearTimeout(timer);
              resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude });
            }, (err)=>{
              if(done) return; done = true; clearTimeout(timer); resolve(null);
            }, { timeout: timeoutMs||5000 });
          });
        }

        // main async flow
        (async ()=>{
          const loc = await getLocationPromise(5000);
          const locationLink = loc ? ('https://maps.google.com/?q=' + loc.latitude + ',' + loc.longitude) : null;
          const messagePlain = loc ? ('üö® I need help! This is an emergency. My location: ' + locationLink) : 'üö® I need help! This is an emergency.';
          const messageEncoded = encodeURIComponent(messagePlain);

          // try API first
          try{
            const res = await sendSosViaAPI(contacts, messagePlain, loc);
            if(res && res.ok){
              try{ if(status) status.textContent = 'SOS sent via backend'; }catch(e){}
              try{ alert('SOS sent via backend to your contacts.'); }catch(e){}
              return;
            }
            console.warn('Backend SOS failed, falling back to SMS composer', res);
          }catch(e){
            console.warn('Backend send error, falling back to SMS composer', e);
          }

          // fallback: open sms: composer per contact
          openSmsFallback(contacts, messageEncoded);
          try{ alert('Opened SMS composer for each contact. Please tap send.'); }catch(e){}
        })();
      }

      // start/stop listener (matches your snippet)
      let listening = false;
      const startBtn = el('startListening');
      if(startBtn){
        startBtn.addEventListener('click', ()=>{
          if(!recognition){ alert('SpeechRecognition not available on your browser'); return; }
          listening = !listening;
          if(listening){ recognition.start(); startBtn.textContent = 'Stop Voice Listener'; if(status) status.textContent='Listening...'; }
          else { recognition.stop(); startBtn.textContent = 'Start Voice Listener'; if(status) status.textContent='Stopped'; }
        });
      }

      // expose small aliases (optional)
      window.playSOSSound = playSOSSound;
      window.triggerSOS = triggerSOS;

      // ----- end Voice SOS -----

      // settings load/save
      const defaultSettings = { notifications: true, privacy: 'contacts', dark: false };
      const settings = Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem('settings')||'{}'));
      const notif = el('toggleNotifications'), privacy = el('privacySelect'), dark = el('toggleDark');

      function applySettings(){
        if(notif) notif.checked = !!settings.notifications;
        if(privacy) privacy.value = settings.privacy || 'contacts';
        if(dark) dark.checked = !!settings.dark;
        if(settings.dark){
          document.getElementById('pageBody').classList.add('dark','bg-slate-900','text-slate-100');
        } else {
          document.getElementById('pageBody').classList.remove('dark','bg-slate-900','text-slate-100');
        }
        el('notifSpan') && (el('notifSpan').style.backgroundColor = settings.notifications ? '#4f46e5' : '#cbd5e1');
        el('darkSwitch') && (el('darkSwitch').style.backgroundColor = settings.dark ? '#111827' : '#cbd5e1');
      }
      applySettings();

      notif && notif.addEventListener('change', ()=>{ settings.notifications = notif.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });
      privacy && privacy.addEventListener('change', ()=>{ settings.privacy = privacy.value; localStorage.setItem('settings', JSON.stringify(settings)); });
      dark && dark.addEventListener('change', ()=>{ settings.dark = dark.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });

      // Edit profile modal handlers
      const modalEdit = el('modalEdit'), editForm = el('editForm');
      el('btnEditProfile') && el('btnEditProfile').addEventListener('click', ()=>{ 
        el('editUsername') && (el('editUsername').value = userProfile?.username || ''); 
        el('editEmail') && (el('editEmail').value = userProfile?.email || ''); 
        modalEdit && modalEdit.classList.remove('hidden'); 
      });
      el('cancelEdit') && el('cancelEdit').addEventListener('click', ()=> modalEdit && modalEdit.classList.add('hidden'));

      editForm && editForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const nu = (el('editUsername') && el('editUsername').value.trim()) || '';
        const ne = (el('editEmail') && el('editEmail').value.trim().toLowerCase()) || '';
        if(!nu || !ne){ alert('Provide username and email.'); return; }

        const result = await apiCall('/user/profile', 'PUT', { username: nu, email: ne });
        if(result && result.user) {
          userProfile = result.user;
          updateProfileUI();
          modalEdit && modalEdit.classList.add('hidden');
          alert('Profile updated.');
          setTimeout(()=> location.reload(), 300);
        } else {
          alert('Failed to update profile.');
        }
      });

      // Change password handlers
      const modalPwd = el('modalPwd'), pwdForm = el('pwdForm');
      el('btnChangePassword') && el('btnChangePassword').addEventListener('click', ()=> modalPwd && modalPwd.classList.remove('hidden'));
      el('cancelPwd') && el('cancelPwd').addEventListener('click', ()=> modalPwd && modalPwd.classList.add('hidden'));

      pwdForm && pwdForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const cur = (el('currentPwd') && el('currentPwd').value) || '';
        const nw = (el('newPwd') && el('newPwd').value) || '';
        const cn = (el('confirmNewPwd') && el('confirmNewPwd').value) || '';
        if(!cur || !nw || !cn){ alert('Fill all fields.'); return; }
        if(nw !== cn){ alert('New passwords do not match.'); return; }
        if(nw.length < 8){ alert('Password must be at least 8 characters.'); return; }

        // For now, password change would require a dedicated endpoint
        alert('Password change feature coming soon.');
        modalPwd && modalPwd.classList.add('hidden');
      });

      // footer year
      el('year') && (el('year').textContent = new Date().getFullYear());
    })();
  </script>

  <!-- Footer -->
  <footer class="w-full bg-gradient-to-r from-indigo-700 to-indigo-600 text-white mt-12">
    <div class="max-w-6xl mx-auto px-6 py-10 grid gap-6 md:grid-cols-4">
      <div>
        <div class="text-lg font-semibold">Suraksha Sathi</div>
        <p class="text-sm mt-2 text-indigo-100">Empowering safe mobility for women using community reports, live insights and SOS alerts.</p>
        <div class="text-xs text-indigo-200 mt-4">Built by students ‚Ä¢ Demo Prototype</div>
      </div>
      <div>
        <div class="font-semibold mb-2">Quick links</div>
        <ul class="space-y-1 text-sm">
          <li><a href="index.html#home" class="hover:text-indigo-200">Home</a></li>
          <li><a href="index.html#route" class="hover:text-indigo-200">Route Finder</a></li>
          <li><a href="index.html#community" class="hover:text-indigo-200">Community</a></li>
          <li><a href="index.html#about" class="hover:text-indigo-200">About</a></li>
        </ul>
      </div>
      <div>
        <div class="font-semibold mb-2">Resources</div>
        <ul class="space-y-1 text-sm">
          <li><a href="https://www.openstreetmap.org" target="_blank" class="hover:text-indigo-200">OpenStreetMap</a></li>
          <li><a href="https://project-osrm.org" target="_blank" class="hover:text-indigo-200">OSRM routing</a></li>
          <li><a href="#" class="hover:text-indigo-200">Privacy & Terms</a></li>
        </ul>
      </div>
      <div>
        <div class="font-semibold mb-2">Contact</div>
        <div class="text-sm text-indigo-100">Email: <a href="mailto:hello@surakshasathi.example" class="hover:text-indigo-200">hello@surakshasathi.example</a></div>
        <div class="text-sm text-indigo-100 mt-2">Phone: <a href="tel:+911234567890" class="hover:text-indigo-200">+91 12345 67890</a></div>
        <div class="flex gap-2 mt-3">
          <a href="#" aria-label="Twitter" class="hover:text-indigo-200">üê¶</a>
          <a href="#" aria-label="Instagram" class="hover:text-indigo-200">üì∏</a>
          <a href="#" aria-label="LinkedIn" class="hover:text-indigo-200">üîó</a>
        </div>
      </div>
    </div>

    <div class="border-t border-indigo-600/50">
      <div class="max-w-6xl mx-auto px-6 py-3 flex flex-col md:flex-row items-center justify-between text-xs text-indigo-200">
        <div>¬© <span id="year"></span> Suraksha Sathi ‚Äî All rights reserved</div>
        <div class="mt-2 md:mt-0">Made with ‚ù§Ô∏è</div>
      </div>
    </div>
  </footer>
</body>
</html>