<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile â€” Suraksha Sathi</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Scoped CSS: modal sizing, overflow & layout fixes -->
  <style>
    /* Ensure global box-sizing is predictable inside this page */
    html, body { box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }

    /* Modal sizing & content box fixes - applied to inner container */
    .modal-inner {
      max-height: 78vh;     /* keep modal inside viewport */
      overflow: auto;       /* scroll inside modal if content is tall */
      padding: 1.25rem;     /* consistent inner padding */
      box-sizing: border-box;
    }

    /* Keep inputs/selects/buttons from forcing horizontal scroll */
    .modal-inner input,
    .modal-inner select,
    .modal-inner button {
      box-sizing: border-box;
      min-width: 0;
    }

    /* Prevent long words or numbers from overflowing */
    .modal-inner .ec-card, .modal-inner .ec-card * {
      word-break: break-word;
    }

    /* Make the save button not wrap and align nicely */
    .ec-save-btn { white-space: nowrap; }

  /* Ensure placeholder text is visible and subdued across browsers */
  .modal-inner ::-webkit-input-placeholder { color: #94a3b8; }
  .modal-inner ::-moz-placeholder { color: #94a3b8; }
  .modal-inner :-ms-input-placeholder { color: #94a3b8; }
  .modal-inner ::placeholder { color: #94a3b8; }

  /* Improve save button alignment in grid */
  .ec-save-wrapper, .ec-save-btn { display: inline-flex; align-items: center; justify-content: center; }

    /* Remove default outline on focus for better Tailwind-like styling */
    .modal-inner input:focus,
    .modal-inner select:focus,
    .modal-inner button:focus {
      outline: 3px solid rgba(99,102,241,0.12);
      outline-offset: 2px;
    }

    /* Small screen adjustments */
    @media (max-width: 640px) {
      .modal-inner { padding: 0.75rem; max-height: 85vh; }
      .ec-row { flex-direction: column; gap: 0.5rem; }
      .ec-save-wrapper { justify-content: flex-end; }
    }

    /* scoped card style for saved contacts */
    .ec-card {
      background: #fff0f6;
      border: 1px solid #ffd6e7;
      color: #372b2f;
    }

    .ec-remove { cursor:pointer; color:#e11d48; font-weight:600; background:transparent; border:0; }

  /* slight backdrop dim z-index safety */
  /* escape slash in class name so CSS is valid */
  .fixed.inset-0.bg-black\/40 { z-index: 999; }
  </style>
</head>

<body id="pageBody" class="bg-slate-100 min-h-screen text-slate-800">
  <!-- HEADER with Back + Logo -->
  <header class="bg-gradient-to-r from-indigo-600 to-indigo-400 text-white p-4 shadow-md">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="btnBack" aria-label="Back" class="inline-flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded text-sm">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="hidden sm:inline">Back</span>
        </button>

        <a href="index.html" class="flex items-center gap-3">
          <div class="w-10 h-10 flex-shrink-0">
            <img src="logo.png" alt="Suraksha Sathi" class="w-full h-full object-cover rounded-full" />
          </div>
          <div class="hidden sm:block">
            <div class="text-lg font-semibold leading-tight text-white">Suraksha Sathi</div>
            <div class="text-xs opacity-90 -mt-0.5 text-white">Because Every Journey Deserves Safety</div>
          </div>
        </a>
      </div>

      <div id="navAuth" class="ml-3"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto mt-8 px-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Profile Card -->
      <section class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center gap-4">
          <div id="avatar" class="w-20 h-20 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 text-2xl font-bold"></div>
          <div>
            <div id="displayName" class="text-xl font-semibold">User</div>
            <div id="displayEmail" class="text-sm text-slate-500">email@example.com</div>
            <div id="displayJoin" class="text-xs text-slate-400 mt-1">Joined: â€”</div>
          </div>
        </div>

        <div class="mt-4 space-x-2">
          <button id="btnEditProfile" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded shadow-sm">Edit Profile</button>
          <button id="btnChangePassword" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded">Change Password</button>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-semibold text-slate-600">Emergency Contacts</h3>

          <div class="mt-3">
            <p class="text-xs text-slate-400 mb-3">Manage trusted contacts who will be notified in an emergency. Contacts are saved to your account.</p>
            <button id="openECModal" class="inline-flex items-center gap-3 px-4 py-2 rounded-md bg-pink-600 hover:bg-pink-700 text-white shadow">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8.5v7a2.5 2.5 0 002.5 2.5h13A2.5 2.5 0 0021 15.5v-7A2.5 2.5 0 0018.5 6h-13A2.5 2.5 0 003 8.5zM8 12h8M8 15h5" /></svg>
              Manage Emergency Contacts
            </button>
          </div>

          <!-- Inline small list (account-specific) -->
          <ul id="emergencyList" class="mt-4 space-y-2 text-sm text-slate-700"></ul>
        </div>
      </section>

      <!-- Stats + Activity (span 2 cols) -->
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-lg font-semibold">Safety Insights</h2>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Safe Routes Taken</div>
              <div id="statRoutes" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Reports Sent</div>
              <div id="statReports" class="text-2xl font-semibold mt-1">0</div>
            </div>
            <div class="p-4 bg-slate-50 rounded">
              <div class="text-xs text-slate-500">Alerts Received</div>
              <div id="statAlerts" class="text-2xl font-semibold mt-1">0</div>
            </div>
          </div>

          <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-600">Recent Activity</h3>
            <ul id="activityList" class="mt-3 space-y-3 text-sm text-slate-700"></ul>
          </div>
        </div>

        <!-- Settings -->
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Settings & Preferences</h2>
            <div class="text-xs text-slate-500">Manage your account</div>
          </div>

          <div class="mt-4 space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Enable Notifications</div>
                <div class="text-xs text-slate-500">Receive app alerts</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleNotifications" type="checkbox" class="sr-only" />
                <span id="notifSpan" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors" aria-hidden="true"></span>
              </label>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Privacy: Share profile</div>
                <div class="text-xs text-slate-500">Who can see your profile</div>
              </div>
              <select id="privacySelect" class="border rounded px-2 py-1 text-sm">
                <option value="private">Private</option>
                <option value="contacts">Contacts only</option>
                <option value="public">Public</option>
              </select>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">Dark Mode</div>
                <div class="text-xs text-slate-500">Switch theme</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleDark" type="checkbox" class="sr-only" />
                <span id="darkSwitch" class="w-11 h-6 rounded-full bg-slate-300 relative transition-colors" aria-hidden="true"></span>
              </label>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="mt-8">
    <div class="max-w-6xl mx-auto text-center text-xs text-slate-500 py-4">Â© <span id="year">2025</span> Suraksha Sathi â€” Your Safety , Our Priority</div>
  </footer>

  <!-- Edit Modal -->
  <div id="modalEdit" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md modal-inner">
      <h3 class="text-lg font-semibold mb-3">Edit Profile</h3>
      <form id="editForm" class="space-y-3">
        <input id="editUsername" type="text" class="w-full px-3 py-2 border rounded" placeholder="Username" />
        <input id="editEmail" type="email" class="w-full px-3 py-2 border rounded" placeholder="Email" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEdit" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="modalPwd" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md modal-inner">
      <h3 class="text-lg font-semibold mb-3">Change Password</h3>
      <form id="pwdForm" class="space-y-3">
        <input id="currentPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Current password" />
        <input id="newPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="New password" />
        <input id="confirmNewPwd" type="password" class="w-full px-3 py-2 border rounded" placeholder="Confirm new password" />
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelPwd" class="px-3 py-2 rounded bg-white border">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Emergency Contacts Modal -->
  <div id="ecModal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl modal-inner">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold">Emergency Contacts</h3>
        <button id="closeECModal" class="text-slate-500 hover:text-slate-700" aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <p class="text-xs text-slate-400 mt-2">Add the people you'd like to notify in an emergency. These contacts are saved per account.</p>

      <form id="ecForm" class="mt-4">
        <div class="grid grid-cols-12 gap-2 items-center ec-row">
          <!-- Name (larger) -->
          <div class="col-span-12 md:col-span-5">
            <input id="ecName" type="text" placeholder="Name" class="w-full px-3 py-2 border rounded text-slate-700 placeholder-slate-400" />
          </div>

          <!-- Country code -->
          <div class="col-span-6 md:col-span-2">
            <select id="countrySelect" class="w-full px-3 py-2 border rounded text-sm text-slate-700">
              <option value="+91">ðŸ‡®ðŸ‡³ IN +91 (India)</option>
              <option value="+1">ðŸ‡ºðŸ‡¸ US +1 (USA)</option>
              <option value="+44">ðŸ‡¬ðŸ‡§ GB +44 (UK)</option>
              <option value="+61">ðŸ‡¦ðŸ‡º AU +61 (Australia)</option>
              <option value="+81">ðŸ‡¯ðŸ‡µ JP +81 (Japan)</option>
              <option value="+49">ðŸ‡©ðŸ‡ª DE +49 (Germany)</option>
              <option value="+33">ðŸ‡«ðŸ‡· FR +33 (France)</option>
              <option value="+971">ðŸ‡¦ðŸ‡ª AE +971 (UAE)</option>
              <option value="+7">ðŸ‡·ðŸ‡º RU +7 (Russia)</option>
              <option value="+86">ðŸ‡¨ðŸ‡³ CN +86 (China)</option>
            </select>
          </div>

          <!-- Phone number -->
          <div class="col-span-6 md:col-span-3">
            <input id="ecPhone" type="tel" placeholder="Phone Number" class="w-full px-3 py-2 border rounded text-slate-700 placeholder-slate-400" />
          </div>

          <!-- Relation + Save button grouped -->
          <div class="col-span-12 md:col-span-2 flex items-center gap-2">
            <select id="relationSelect" class="flex-1 px-3 py-2 border rounded text-sm text-slate-700">
              <option value="">Relation</option>
              <option value="Friend">Friend</option>
              <option value="Mother">Mother</option>
              <option value="Sister">Sister</option>
              <option value="Brother">Brother</option>
              <option value="Father">Father</option>
              <option value="Boyfriend">Boyfriend</option>
              <option value="Uncle">Uncle</option>
              <option value="Aunt">Aunt</option>
              <option value="Other">Other</option>
            </select>

            <button id="saveContactBtn" type="submit" class="px-3 py-2 rounded-md bg-pink-600 hover:bg-pink-700 text-white ec-save-btn w-24 text-center">Save</button>
          </div>
        </div>
      </form>

      <div class="mt-4">
        <div class="flex items-center justify-between">
          <h4 class="font-semibold">Saved Contacts</h4>
          <div class="flex items-center gap-2">
            <button id="clearAllEC" class="px-3 py-1 rounded border text-sm">Clear All</button>
          </div>
        </div>

        <ul id="ecList" class="mt-3 space-y-3"></ul>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Back button behavior
      document.addEventListener('DOMContentLoaded', function () {
        const backBtn = document.getElementById('btnBack');
        if (backBtn) {
          backBtn.addEventListener('click', function (e) {
            e.preventDefault();
            try {
              if (window.history && window.history.length > 1) { window.history.back(); return; }
              if (document.referrer) {
                try {
                  const r = new URL(document.referrer);
                  if (r.origin === location.origin) { window.location.href = document.referrer; return; }
                } catch (err) {}
              }
              window.location.href = 'index.html';
            } catch (err) { window.location.href = 'index.html'; }
          });
        }
      });

      // helpers
      const esc = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const el = id => document.getElementById(id);
      function getUsers(){ try{ return JSON.parse(localStorage.getItem('users')||'[]'); }catch(e){ return []; } }

      // auth check (redirect if not logged in)
      const authUser = JSON.parse(localStorage.getItem('authUser') || 'null');
      if(!authUser){ window.location.href = 'login.html'; return; }

      // render header auth
      const nav = el('navAuth');
      if(nav){
        nav.innerHTML = `
          <a href="profile.html" class="inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded text-sm">${esc(authUser.username||authUser.email)}</a>
          <button id="logoutBtn" class="ml-2 px-3 py-1 rounded bg-white/10 border border-white/20 text-sm">Logout</button>
        `;
        const logoutBtn = el('logoutBtn');
        logoutBtn && logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('authUser'); window.location.href = 'login.html'; });
      }

      // user record
      const users = getUsers();
      const me = users.find(u => u.email === authUser.email) || { username: authUser.username, email: authUser.email, created: Date.now() };

      // populate profile header safely
      const avatar = el('avatar'), nameEl = el('displayName'), emailEl = el('displayEmail'), joinEl = el('displayJoin');
      const initials = ((me.username || me.email || 'U').trim().split(/\s+/)[0] || 'U').charAt(0).toUpperCase();
      if(avatar) avatar.textContent = initials;
      if(nameEl) nameEl.textContent = me.username || authUser.username || '';
      if(emailEl) emailEl.textContent = me.email || authUser.email || '';
      if(joinEl){
        const joined = me.created ? new Date(me.created) : new Date();
        joinEl.textContent = 'Joined: ' + joined.toLocaleDateString();
      }

      // stats
      const statRoutes = Number(localStorage.getItem('stat_routes')||0);
      const statReports = Number(localStorage.getItem('stat_reports')||0);
      const statAlerts = Number(localStorage.getItem('stat_alerts')||0);
      el('statRoutes') && (el('statRoutes').textContent = statRoutes);
      el('statReports') && (el('statReports').textContent = statReports);
      el('statAlerts') && (el('statAlerts').textContent = statAlerts);

      // activity
      function loadActivity(){
        let acts = [];
        try{ acts = JSON.parse(localStorage.getItem('activity')||'[]'); }catch(e){ acts = []; }
        if(!acts.length){
          acts = [
            { when: Date.now()-3600*1000, text: 'Checked a safe route' },
            { when: Date.now()-3600*24*1000, text: 'Reported an area' },
            { when: Date.now()-3600*48*1000, text: 'Viewed community post' }
          ];
        }
        const list = el('activityList');
        if(!list) return;
        list.innerHTML = acts.slice(0,6).map(a => `<li class="p-3 rounded bg-slate-50 flex justify-between items-start"><div>${esc(a.text)}</div><div class="text-xs text-slate-400">${new Date(a.when).toLocaleString()}</div></li>`).join('');
      }
      loadActivity();

      // ----- Emergency Contacts modal + per-user persistence -----
      const ecModal = el('ecModal'), openECModal = el('openECModal'), closeECModal = el('closeECModal');
      const ecForm = el('ecForm'), ecName = el('ecName'), ecPhone = el('ecPhone'), countrySelect = el('countrySelect'), relationSelect = el('relationSelect');
      const saveContactBtn = el('saveContactBtn'), ecList = el('ecList'), clearAllEC = el('clearAllEC');

      // per-user key
      const EC_KEY = 'emergencyContacts_' + (authUser.email || authUser.username || 'default');

      function readEC(){
        try{ return JSON.parse(localStorage.getItem(EC_KEY) || '[]'); }catch(e){ return []; }
      }
      function writeEC(arr){ localStorage.setItem(EC_KEY, JSON.stringify(arr)); }

      function renderECs(){
        const arr = readEC();
        if(!ecList) return;
        if(!arr.length){
          ecList.innerHTML = '<li class="text-xs text-slate-400">No emergency contacts yet.</li>';
          return;
        }
        ecList.innerHTML = arr.map((c, idx) => `
          <li class="p-3 rounded ec-card flex justify-between items-start">
            <div>
              <div class="font-semibold">${esc(c.name)}</div>
              <div class="text-sm text-slate-600">Phone: ${esc(c.country)} ${esc(c.phone)}</div>
              <div class="text-sm text-slate-600">Relation: ${esc(c.relation)}</div>
            </div>
            <div class="ml-4 text-sm">
              <button class="ec-remove" data-idx="${idx}" title="Remove contact">âœ–</button>
            </div>
          </li>
        `).join('');
        const removes = ecList.querySelectorAll('.ec-remove');
        removes.forEach(btn => btn.addEventListener('click', function(){
          const i = Number(this.getAttribute('data-idx'));
          const list = readEC();
          if(i>=0 && i<list.length){
            list.splice(i,1);
            writeEC(list);
            renderECs();
            renderInlineECList();
          }
        }));
      }

      openECModal && openECModal.addEventListener('click', ()=>{ ecModal && ecModal.classList.remove('hidden'); renderECs(); renderInlineECList(); });
      closeECModal && closeECModal.addEventListener('click', ()=>{ ecModal && ecModal.classList.add('hidden'); });

      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ ecModal && ecModal.classList.add('hidden'); modalEdit && modalEdit.classList.add('hidden'); modalPwd && modalPwd.classList.add('hidden'); }});

      ecForm && ecForm.addEventListener('submit', function(e){
        e.preventDefault();
        const name = (ecName.value || '').trim();
        const phoneRaw = (ecPhone.value || '').replace(/\D/g,'').trim();
        const country = countrySelect.value || '';
        const relation = relationSelect.value || '';

        if(!name){ alert('Please enter a name'); ecName.focus(); return; }
        if(!phoneRaw){ alert('Please enter a phone number'); ecPhone.focus(); return; }
        if(!relation){ alert('Please select relation'); relationSelect.focus(); return; }

        const list = readEC();
        const exists = list.some(it => it.phone === phoneRaw && it.country === country);
        if(exists){ alert('This contact already exists.'); return; }

        list.push({ id: Date.now(), name, phone: phoneRaw, country, relation });
        writeEC(list);
        renderECs();
        ecForm.reset();
        renderInlineECList();
      });

      clearAllEC && clearAllEC.addEventListener('click', function(){
        if(!confirm('Clear all emergency contacts for this account?')) return;
        localStorage.removeItem(EC_KEY);
        renderECs();
        renderInlineECList();
      });

      function renderInlineECList(){
        const ul = el('emergencyList');
        if(!ul) return;
        const arr = readEC();
        if(!arr.length){
          ul.innerHTML = '<li class="text-xs text-slate-400">No emergency contacts yet. Click "Manage Emergency Contacts" to add.</li>';
          return;
        }
        ul.innerHTML = arr.map((ct, i)=>`<li class="flex items-center justify-between bg-slate-50 p-2 rounded">
          <div><div class="font-medium">${esc(ct.name)}</div><div class="text-xs text-slate-500">${esc(ct.country)} ${esc(ct.phone)}</div></div>
          <button data-i="${i}" class="removeContact text-red-500 text-sm">Remove</button>
        </li>`).join('');
        ul.querySelectorAll('.removeContact').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const idx = Number(btn.dataset.i);
            const arr2 = readEC();
            arr2.splice(idx,1);
            writeEC(arr2);
            renderInlineECList();
            renderECs();
          });
        });
      }

      // initial render
      renderECs();
      renderInlineECList();

      // ----- end emergency contacts -----

      // settings load/save
      const defaultSettings = { notifications: true, privacy: 'contacts', dark: false };
      const settings = Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem('settings')||'{}'));
      const notif = el('toggleNotifications'), privacy = el('privacySelect'), dark = el('toggleDark');

      function applySettings(){
        if(notif) notif.checked = !!settings.notifications;
        if(privacy) privacy.value = settings.privacy || 'contacts';
        if(dark) dark.checked = !!settings.dark;
        if(settings.dark){
          document.getElementById('pageBody').classList.add('dark','bg-slate-900','text-slate-100');
        } else {
          document.getElementById('pageBody').classList.remove('dark','bg-slate-900','text-slate-100');
        }
        el('notifSpan') && (el('notifSpan').style.backgroundColor = settings.notifications ? '#4f46e5' : '#cbd5e1');
        el('darkSwitch') && (el('darkSwitch').style.backgroundColor = settings.dark ? '#111827' : '#cbd5e1');
      }
      applySettings();

      notif && notif.addEventListener('change', ()=>{ settings.notifications = notif.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });
      privacy && privacy.addEventListener('change', ()=>{ settings.privacy = privacy.value; localStorage.setItem('settings', JSON.stringify(settings)); });
      dark && dark.addEventListener('change', ()=>{ settings.dark = dark.checked; localStorage.setItem('settings', JSON.stringify(settings)); applySettings(); });

      // Edit profile modal handlers
      const modalEdit = el('modalEdit'), editForm = el('editForm');
      el('btnEditProfile') && el('btnEditProfile').addEventListener('click', ()=>{ el('editUsername') && (el('editUsername').value = me.username || ''); el('editEmail') && (el('editEmail').value = me.email || ''); modalEdit && modalEdit.classList.remove('hidden'); });
      el('cancelEdit') && el('cancelEdit').addEventListener('click', ()=> modalEdit && modalEdit.classList.add('hidden'));

      editForm && editForm.addEventListener('submit', function(e){
        e.preventDefault();
        const nu = (el('editUsername') && el('editUsername').value.trim()) || '';
        const ne = (el('editEmail') && el('editEmail').value.trim().toLowerCase()) || '';
        if(!nu || !ne){ alert('Provide username and email.'); return; }

        const all = getUsers();
        const idx = all.findIndex(u=>u.email === me.email);
        if(idx >= 0){
          const other = all.find((u,i)=>u.email === ne && i !== idx);
          if(other){ alert('Email already used by another account.'); return; }
          all[idx].username = nu; all[idx].email = ne;
          localStorage.setItem('users', JSON.stringify(all));
        } else {
          all.push({ username: nu, email: ne, created: me.created || Date.now() });
          localStorage.setItem('users', JSON.stringify(all));
        }
        const newAuth = { username: nu, email: ne };
        localStorage.setItem('authUser', JSON.stringify(newAuth));
        el('displayName') && (el('displayName').textContent = nu);
        el('displayEmail') && (el('displayEmail').textContent = ne);
        modalEdit && modalEdit.classList.add('hidden');
        alert('Profile updated.');
        setTimeout(()=> location.reload(), 300);
      });

      // Change password handlers
      const modalPwd = el('modalPwd'), pwdForm = el('pwdForm');
      el('btnChangePassword') && el('btnChangePassword').addEventListener('click', ()=> modalPwd && modalPwd.classList.remove('hidden'));
      el('cancelPwd') && el('cancelPwd').addEventListener('click', ()=> modalPwd && modalPwd.classList.add('hidden'));

      pwdForm && pwdForm.addEventListener('submit', function(e){
        e.preventDefault();
        const cur = (el('currentPwd') && el('currentPwd').value) || '';
        const nw = (el('newPwd') && el('newPwd').value) || '';
        const cn = (el('confirmNewPwd') && el('confirmNewPwd').value) || '';
        if(!cur || !nw || !cn){ alert('Fill all fields.'); return; }
        if(nw !== cn){ alert('New passwords do not match.'); return; }
        const all = getUsers();
        const idx = all.findIndex(u => u.email === me.email);
        if(idx === -1 || all[idx].password !== cur){
          alert('Current password incorrect.');
          return;
        }
        all[idx].password = nw;
        localStorage.setItem('users', JSON.stringify(all));
        modalPwd && modalPwd.classList.add('hidden');
        alert('Password updated.');
      });

      // footer year
      el('year') && (el('year').textContent = new Date().getFullYear());
    })();
  </script>
</body>
</html>