<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suraksha Sathi - Voice SOS (Enhanced)</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; transition: background 0.3s; }
    input, button, textarea { font-size: 16px; padding: 8px; margin: 6px 0; width: 100%; }
    .row { display: flex; gap: 8px; }
    .contacts { margin-top: 12px; }
    .alert-glow {
      background: red;
      color: white;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <h2>Suraksha Sathi â€” Voice SOS (Enhanced)</h2>

  <label>Set your custom voice command (example: help me 123)</label>
  <input id="voiceCmd" placeholder="Type your voice command" />

  <label>Emergency Contact (Name,Phone,Relation)</label>
  <div class="row">
    <input id="cName" placeholder="Name" />
    <input id="cPhone" placeholder="+91XXXXXXXXXX" />
    <input id="cRelation" placeholder="Relation (e.g., Sister)" />
  </div>
  <button id="addContact">Add Contact</button>

  <div class="contacts">
    <h4>Saved Contacts</h4>
    <ul id="contactList"></ul>
  </div>

  <button id="startListening">Start Voice Listener</button>
  <p id="status">Status: idle</p>

<script>
const voiceCmdInput = document.getElementById('voiceCmd');
const addContactBtn = document.getElementById('addContact');
const contactList = document.getElementById('contactList');
const startBtn = document.getElementById('startListening');
const status = document.getElementById('status');

function load() {
  const cmd = localStorage.getItem('sos_cmd') || '';
  voiceCmdInput.value = cmd;
  renderContacts();
}

function saveCmd() {
  localStorage.setItem('sos_cmd', voiceCmdInput.value.trim());
}
voiceCmdInput.addEventListener('change', saveCmd);

function getContacts() {
  return JSON.parse(localStorage.getItem('sos_contacts') || '[]');
}
function saveContacts(arr) {
  localStorage.setItem('sos_contacts', JSON.stringify(arr));
}
function renderContacts() {
  const arr = getContacts();
  contactList.innerHTML = '';
  arr.forEach((c, i) => {
    const li = document.createElement('li');
    li.textContent = `${c.name} â€” ${c.phone} (${c.relation}) `;
    const btn = document.createElement('button');
    btn.textContent = 'Remove';
    btn.style.marginLeft = '8px';
    btn.addEventListener('click', () => {
      arr.splice(i, 1);
      saveContacts(arr);
      renderContacts();
    });
    li.appendChild(btn);
    contactList.appendChild(li);
  });
}

addContactBtn.addEventListener('click', () => {
  const name = document.getElementById('cName').value.trim();
  const phone = document.getElementById('cPhone').value.trim();
  const relation = document.getElementById('cRelation').value.trim();
  if (!name || !phone) {
    alert('Enter name and phone');
    return;
  }
  // Simple phone validation (Indian number format)
  const phoneRegex = /^\+?\d{10,15}$/;
  if (!phoneRegex.test(phone)) {
    alert('Enter valid phone number (with country code)');
    return;
  }
  const arr = getContacts();
  arr.push({ name, phone, relation });
  saveContacts(arr);
  renderContacts();
  document.getElementById('cName').value = '';
  document.getElementById('cPhone').value = '';
  document.getElementById('cRelation').value = '';
});

// ------- Speech recognition -------
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-IN';
  recognition.interimResults = false;
  recognition.continuous = true;

  recognition.onresult = (e) => {
    const text = e.results[e.results.length - 1][0].transcript.trim();
    status.textContent = 'Heard: ' + text;
    checkCommand(text);
  };

  recognition.onerror = (e) => {
    console.error(e);
    status.textContent = 'Error: ' + e.error;
  };

  recognition.onend = () => {
    status.textContent = 'Listener stopped';
    if (listening) {
      // Automatically restart recognition to keep listening continuously
      recognition.start();
      status.textContent = 'Listening...';
    }
  };
} else {
  status.textContent = 'SpeechRecognition not supported in this browser';
}

function checkCommand(spoken) {
  const cmd = (localStorage.getItem('sos_cmd') || '').toLowerCase();
  if (!cmd) {
    console.log('No voice command set');
    return;
  }
  if (spoken.toLowerCase().includes(cmd)) {
    status.textContent = 'Trigger matched! Preparing messages...';
    playSOSSound();
    document.body.classList.add('alert-glow');
    setTimeout(() => document.body.classList.remove('alert-glow'), 5000);
    triggerSOS();
  }
}

// --- Play emergency sound ---
function playSOSSound() {
  const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
  audio.play().catch(() => {});
}

/* Fallback send: open sms: links (with live location link)
   Message will be prefilled. User must tap send (browser security).
*/
function triggerSOS() {
  const contacts = getContacts();
  if (!contacts.length) {
    alert('No contacts saved');
    return;
  }

  navigator.geolocation.getCurrentPosition((pos) => {
    const { latitude, longitude } = pos.coords;
    const locationLink = `https://maps.google.com/?q=${latitude},${longitude}`;
    const message = encodeURIComponent(`ðŸš¨ I need help! This is an emergency. My location: ${locationLink}`);
    contacts.forEach((c) => {
      const phone = c.phone.replace(/\s+/g, '');
      const smsUrl = `sms:${phone}?body=${message}`;
      window.open(smsUrl, '_blank');
    });
    alert('Opened SMS composer with location for each contact.');
  }, (err) => {
    alert('Could not get location: ' + err.message);
  });
}

// start/stop listener
let listening = false;
startBtn.addEventListener('click', () => {
  if (!recognition) {
    alert('SpeechRecognition not available on your browser');
    return;
  }
  listening = !listening;
  if (listening) {
    recognition.start();
    startBtn.textContent = 'Stop Voice Listener';
    status.textContent = 'Listening...';
  } else {
    recognition.stop();
    startBtn.textContent = 'Start Voice Listener';
    status.textContent = 'Stopped';
  }
});

// initial load
load();
</script>
</body>
</html>